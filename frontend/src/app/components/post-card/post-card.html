<!-- Main Post Content - Only show if not hidden OR if user is owner/admin -->
<ng-container *ngIf="!post.hidden || (post.hidden && (currentUser?.isAdmin || currentUser?.id === post.user.id))">
    <article class="post-card" [class.is-hidden]="post.hidden">
        <!-- Hidden Badge -->
        <div class="hidden-badge" *ngIf="post.hidden">
            <span class="material-symbols-outlined">visibility_off</span>
            <span>This post is hidden from public</span>
            <button class="btn-unhide" *ngIf="isAdmin" (click)="togglePostVisibility($event, post)">Unhide</button>
        </div>
        <div class="post-header">
            <div class="post-author">
                <!-- Changed post.author to post.user to match data model -->
                <div class="post-avatar" *ngIf="post.user.avatar"
                    [style.background-image]="'url(' + post.user.avatar + ')'" [routerLink]="['/profile', post.user.id]"
                    style="cursor: pointer;">
                </div>
                <div class="post-avatar avatar-initials" *ngIf="!post.user.avatar"
                    [routerLink]="['/profile', post.user.id]" style="cursor: pointer;">
                    {{ getInitials(post.user.name) }}
                </div>
                <div class="post-author-info">
                    <div class="author-row">
                        <a [routerLink]="['/profile', post.user.id]" class="post-author-name"
                            style="cursor: pointer;">{{
                            post.user.name }}</a>
                        <span class="post-author-handle">{{ post.user.handle }}</span>
                    </div>
                    <p class="post-meta">{{ (post.createdAt || post.time) |
                        date:'short'
                        }}</p>
                </div>
            </div>
            <app-action-menu [items]="postActions" (actionSelected)="handleDropdownAction($event)"
                buttonClass="post-menu-btn"></app-action-menu>
        </div>

        <div class="post-content">
            <h3 class="post-title truncated-title" *ngIf="post.title" (click)="openPostDetails($event)"
                style="cursor: pointer;">{{ post.title }}</h3>
            <p class="post-text" [class.truncated]="!isExpanded">
                {{ post.content }}
            </p>
            <button type="button" class="read-more-btn"
                *ngIf="post.content && (post.content.length > 100 || post.content.split('\n').length > 3)"
                (click)="toggleExpand()">
                {{ isExpanded ? 'Show less' : 'See more' }}
            </button>
        </div>

        <div class="post-media" *ngIf="hasMedia">
            <div class="media-slider" [style.transform]="'translateX(-' + (currentSlide * 100) + '%)'">
                <div class="media-slide" *ngFor="let media of mediaItems; let i = index">
                    <div *ngIf="media.isVideo" class="video-container">
                        <video class="post-video" controls playsinline preload="metadata" (click)="$event.stopPropagation()"
                            [poster]="media.poster || ''"
                            (dblclick)="openMediaFullscreen($event, i)">
                            <source [src]="media.url">
                            Your browser does not support the video tag.
                        </video>
                    </div>

                    <div *ngIf="!media.isVideo" class="post-image" (click)="openMediaFullscreen($event, i)"
                        style="cursor: zoom-in;">
                        <img [src]="media.url" alt="Post image" class="post-image-content"
                            style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                    </div>

                    <button type="button" class="media-expand-btn" (click)="openMediaFullscreen($event, i)"
                        [attr.aria-label]="'Open media ' + (i + 1) + ' fullscreen'">
                        <span class="material-symbols-outlined">open_in_full</span>
                    </button>
                </div>
            </div>

            <button type="button" class="media-details-btn" (click)="openPostDetails($event, currentSlide)">
                <span class="material-symbols-outlined">article</span>
                Details
            </button>

            <div class="slider-nav" *ngIf="mediaItems.length > 1">
                <button class="slider-btn prev" (click)="prevSlide($event)" [style.opacity]="currentSlide === 0 ? 0 : 1"
                    [disabled]="currentSlide === 0">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button class="slider-btn next" (click)="nextSlide($event)"
                    [style.opacity]="currentSlide === mediaItems.length - 1 ? 0 : 1"
                    [disabled]="currentSlide === mediaItems.length - 1">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>

            <div class="media-dots" *ngIf="mediaItems.length > 1">
                <button type="button" class="dot" *ngFor="let item of mediaItems; let i = index"
                    [class.active]="i === currentSlide" (click)="goToSlide($event, i)"
                    [attr.aria-label]="'Go to media ' + (i + 1)">
                </button>
            </div>
        </div>

        <div class="post-actions">
            <div class="post-action-group">
                <button type="button" class="post-action-btn" [class.liked]="post.isLiked" (click)="toggleLike()"
                    aria-label="Like post">
                    <span class="material-symbols-outlined" [class.filled]="post.isLiked">favorite</span>
                    <span class="action-count">{{ post.likes }}</span>
                </button>
                <button class="post-action-btn" (click)="openPostDetails($event)">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span class="action-count">{{ post.comments }}</span>
                </button>
            </div>
        </div>
    </article>

    <div class="media-fullscreen-backdrop" *ngIf="isFullscreenOpen" (click)="closeMediaFullscreen($event)">
        <div class="media-fullscreen-content" (click)="$event.stopPropagation()">
            <button type="button" class="fullscreen-details-btn" (click)="openPostDetails($event, fullscreenSlide)"
                aria-label="Open post details">
                <span class="material-symbols-outlined">article</span>
            </button>
            <button type="button" class="fullscreen-close-btn" (click)="closeMediaFullscreen($event)"
                aria-label="Close media viewer">
                <span class="material-symbols-outlined">close</span>
            </button>

            <div class="media-fullscreen-slider"
                [style.transform]="'translateX(-' + (fullscreenSlide * 100) + '%)'">
                <div class="media-fullscreen-slide" *ngFor="let media of mediaItems; let i = index">
                    <div *ngIf="media.isVideo" class="fullscreen-video-wrap">
                        <video class="fullscreen-video" controls playsinline preload="metadata"
                            [poster]="media.poster || ''">
                            <source [src]="media.url">
                        </video>
                    </div>
                    <img *ngIf="!media.isVideo" [src]="media.url" alt="Post media" class="fullscreen-image" />
                </div>
            </div>

            <div class="fullscreen-nav" *ngIf="mediaItems.length > 1">
                <button type="button" class="slider-btn prev" (click)="prevFullscreen($event)"
                    [disabled]="fullscreenSlide === 0">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button type="button" class="slider-btn next" (click)="nextFullscreen($event)"
                    [disabled]="fullscreenSlide === mediaItems.length - 1">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>

            <div class="fullscreen-dots" *ngIf="mediaItems.length > 1">
                <button type="button" class="dot" *ngFor="let item of mediaItems; let i = index"
                    [class.active]="i === fullscreenSlide" (click)="goToFullscreenSlide($event, i)"
                    [attr.aria-label]="'Go to fullscreen media ' + (i + 1)">
                </button>
            </div>
        </div>
    </div>
</ng-container>
