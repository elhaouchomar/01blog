<div class="db-page-container">
    <app-db-page-header title="Safety & Reports" subtitle="Review and handle user and post reports." titleIcon="flag"
        iconColor="var(--warning)">
    </app-db-page-header>

    <!-- Toolbar -->
    <div class="db-toolbar reports-toolbar">
        <div class="filter-section">
            <span class="filter-label">Status Filter</span>
            <div class="pill-group">
                <button class="pill-btn" [class.active]="statusFilter() === 'PENDING'"
                    (click)="setStatusFilter('PENDING')" title="Queue">
                    <span class="material-symbols-outlined">inbox</span>
                    <span>Pending</span>
                </button>
                <button class="pill-btn" [class.active]="statusFilter() === 'RESOLVED'"
                    (click)="setStatusFilter('RESOLVED')" title="Resolved">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>Resolved</span>
                </button>
                <button class="pill-btn" [class.active]="statusFilter() === 'ALL'" (click)="setStatusFilter('ALL')"
                    title="All Reports">
                    <span class="material-symbols-outlined">filter_list</span>
                    <span>All</span>
                </button>
            </div>
        </div>
        <div class="toolbar-stats">
            <span class="count-badge">
                Total: {{ filteredReports().length }}
            </span>
        </div>
    </div>

    <!-- Data Table -->
    <div class="db-card table-card" *ngIf="filteredReports().length > 0 && !isLoading()">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="col-target">Target</th>
                        <th class="col-reason hide-md">Reason</th>
                        <th class="col-reporter hide-lg">Reporter</th>
                        <th class="col-status">Status</th>
                        <th class="col-date hide-xl">Date</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let report of paginatedReports()">
                        <td>
                            <div class="target-cell">
                                <div class="target-preview" (click)="handleView(report)">
                                    <img *ngIf="report.reportedPostImage || report.reportedUser?.avatar"
                                        [src]="report.reportedPostImage || report.reportedUser?.avatar" alt="Thumbnail">
                                    <div *ngIf="!report.reportedPostImage && !report.reportedUser?.avatar"
                                        class="placeholder-icon">
                                        <span class="material-symbols-outlined">{{ report.reportedPostId ? 'article' :
                                            'person' }}</span>
                                    </div>
                                </div>
                                <div class="target-info">
                                    <h6 class="target-title" (click)="handleView(report)">
                                        {{ getTargetLabel(report) }}
                                    </h6>
                                    <p class="target-id">#{{ report.id }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="hide-md">
                            <p class="reason-text" [title]="report.reason">{{ report.reason }}</p>
                        </td>
                        <td class="hide-lg">
                            <span class="reporter-name">{{ getReporterLabel(report) }}</span>
                        </td>
                        <td>
                            <span class="status-badge" [class.resolved]="report.status === 'RESOLVED'">
                                {{ formatStatus(report.status) | titlecase }}
                            </span>
                        </td>
                        <td class="hide-xl">
                            <span class="date-text">{{ report.createdAt | date:'MMM d, yyyy' }}</span>
                        </td>
                        <td>
                            <div class="action-group">
                                <button class="btn-icon success"
                                    (click)="handleReportAction({ report, action: 'resolve' })" title="Resolve">
                                    <span class="material-symbols-outlined">check_circle</span>
                                </button>
                                <button *ngIf="report.reportedPostId" class="btn-icon warning"
                                    (click)="handleReportAction({ report, action: 'toggleVisibility' })"
                                    title="Toggle Visibility">
                                    <span class="material-symbols-outlined">cancel</span>
                                </button>
                                <button *ngIf="report.reportedPostId" class="btn-icon danger"
                                    (click)="handleReportAction({ report, action: 'deletePost' })" title="Delete Post">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                                <button *ngIf="report.reportedUser || report.reportedPostAuthor" class="btn-icon"
                                    [class.unban]="(report.reportedUser || report.reportedPostAuthor).banned"
                                    (click)="handleReportAction({ report, action: 'banUser' })"
                                    [title]="(report.reportedUser || report.reportedPostAuthor).banned ? 'Unban User' : 'Ban User'">
                                    <span class="material-symbols-outlined">{{
                                        (report.reportedUser || report.reportedPostAuthor).banned ? 'check_circle' :
                                        'block' }}</span>
                                </button>
                                <button
                                    *ngIf="dataService.currentUser()?.isAdmin && (report.reportedUser || report.reportedPostAuthor)"
                                    class="btn-icon danger"
                                    (click)="handleReportAction({ report, action: 'deleteUser' })" title="Delete User">
                                    <span class="material-symbols-outlined">person_remove</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Feedbacks -->
    <app-db-feedback *ngIf="filteredReports().length === 0 && !isLoading()" type="empty" icon="flag"
        iconColor="var(--warning)" title="No reports yet" [message]="emptyStateMessage()">
    </app-db-feedback>

    <app-db-feedback *ngIf="isLoading()" type="loading"></app-db-feedback>

    <!-- Pagination -->
    <app-db-pagination *ngIf="filteredReports().length > 0 && !isLoading()" [pagination]="pagination"
        [totalItems]="filteredReports().length" label="reports">
    </app-db-pagination>
</div>