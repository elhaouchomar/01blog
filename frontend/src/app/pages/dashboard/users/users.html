<div class="container-fluid py-4">
    <app-db-page-header title="User Management" subtitle="Monitor and manage user accounts, roles and permissions."
        titleIcon="group" iconColor="#6f42c1" actionIcon="person_add" actionLabel="Add User"
        (click)="modalService.open('create-user')">
    </app-db-page-header>

    <!-- Filters -->
    <div class="d-flex flex-wrap gap-3 mb-4 align-items-center bg-white p-3 rounded-4 shadow-sm border">
        <div class="position-relative flex-grow-1" style="max-width: 400px;">
            <span class="material-symbols-outlined position-absolute top-50 start-0 translate-middle-y ms-3"
                style="color: #6f42c1;">search</span>
            <input type="text" class="form-control form-control-lg ps-5 fs-6 border-0 bg-light rounded-3"
                placeholder="Search by name, email or role..." [ngModel]="searchQuery()" (input)="onSearch($event)">
        </div>
        <div class="d-flex align-items-center gap-2 ms-auto">
            <span class="text-secondary small fw-bold text-uppercase me-2"
                style="letter-spacing: 0.05em;">Filter:</span>
            <div class="btn-group btn-group-sm p-1 bg-light rounded-pill border shadow-sm">
                <button class="btn rounded-pill px-3 transition-all"
                    [ngClass]="{'btn-pill-active': statusFilter() === 'all', 'text-secondary': statusFilter() !== 'all'}"
                    (click)="setStatusFilter('all')" title="All Users">
                    <span class="material-symbols-outlined fs-5 d-block">group</span>
                </button>
                <button class="btn rounded-pill px-3 transition-all"
                    [ngClass]="{'btn-pill-active': statusFilter() === 'active', 'text-secondary': statusFilter() !== 'active'}"
                    (click)="setStatusFilter('active')" title="Active Users">
                    <span class="material-symbols-outlined fs-5 d-block">person</span>
                </button>
                <button class="btn rounded-pill px-3 transition-all"
                    [ngClass]="{'btn-pill-active': statusFilter() === 'banned', 'text-secondary': statusFilter() !== 'banned'}"
                    (click)="setStatusFilter('banned')" title="Banned Users">
                    <span class="material-symbols-outlined fs-5 d-block">block</span>
                </button>
                <button class="btn rounded-pill px-3 transition-all"
                    [ngClass]="{'btn-pill-active': statusFilter() === 'admins', 'text-secondary': statusFilter() !== 'admins'}"
                    (click)="setStatusFilter('admins')" title="Administrators">
                    <span class="material-symbols-outlined fs-5 d-block">admin_panel_settings</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white mb-4"
        *ngIf="filteredUsers().length > 0 && !isLoading()">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light border-bottom text-secondary small fw-bold text-uppercase"
                    style="letter-spacing: 0.05em;">
                    <tr>
                        <th class="ps-4 py-3">User</th>
                        <th class="py-3 d-none d-md-table-cell">Role</th>
                        <th class="py-3 text-center">Status</th>
                        <th class="py-3 d-none d-lg-table-cell">Joined</th>
                        <th class="pe-4 py-3 text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of filteredUsers()">
                        <td class="ps-4 py-3">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle border border-2 shadow-sm flex-shrink-0"
                                    style="width: 40px; height: 40px; background-size: cover; cursor: pointer;"
                                    [style.background-image]="'url(' + (user.avatar || 'assets/default-avatar.png') + ')'"
                                    (click)="router.navigate(['/profile', user.id])">
                                </div>
                                <div class="text-truncate" style="max-width: 150px;">
                                    <h6 class="mb-0 fw-bold text-truncate" style="cursor: pointer;"
                                        (click)="router.navigate(['/profile', user.id])">
                                        {{ user.name }}
                                    </h6>
                                    <p class="text-secondary small mb-0 text-truncate">{{ user.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 d-none d-md-table-cell">
                            <span class="badge rounded-pill fw-bold py-2 px-3"
                                [class.bg-primary-subtle.text-primary]="user.role === 'ADMIN'"
                                [class.bg-secondary-subtle.text-secondary]="user.role !== 'ADMIN'">
                                {{ user.role }}
                            </span>
                        </td>
                        <td class="py-3 text-center">
                            <div
                                class="d-inline-flex align-items-center gap-2 bg-light px-2 py-1 rounded-pill border shadow-sm">
                                <span class="p-1 rounded-circle"
                                    [style.background-color]="user.banned ? '#ef4444' : '#198754'"></span>
                                <span class="small fw-bold text-uppercase d-none d-sm-inline"
                                    [style.color]="user.banned ? '#ef4444' : '#198754'" style="font-size: 10px;">{{
                                    user.banned ?
                                    'Banned' : 'Active' }}</span>
                            </div>
                        </td>
                        <td class="py-3 text-secondary small fw-medium d-none d-lg-table-cell">
                            {{ user.createdAt | date:'MMM d, yyyy' }}
                        </td>
                        <td class="pe-4 py-3 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-white btn-sm rounded-3 p-2 shadow-sm"
                                    [class.text-danger]="!user.banned" [class.text-success]="user.banned"
                                    (click)="toggleBan(user)" [title]="user.banned ? 'Unban' : 'Ban'">
                                    <span class="material-symbols-outlined fs-5">{{ user.banned ? 'check_circle' :
                                        'block' }}</span>
                                </button>
                                <button class="btn btn-white btn-sm text-danger hover-danger-bg rounded-3 p-2 shadow-sm"
                                    *ngIf="dataService.currentUser()?.isAdmin" (click)="deleteUser(user)"
                                    title="Delete Account">
                                    <span class="material-symbols-outlined fs-5">person_remove</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty/Loading States -->
    <app-db-feedback *ngIf="filteredUsers().length === 0 && !isLoading()" type="empty" icon="person_search"
        iconColor="#6f42c1" title="No users found" message="Try adjusting your search or status filters.">
    </app-db-feedback>

    <app-db-feedback *ngIf="isLoading()" type="loading"></app-db-feedback>
</div>