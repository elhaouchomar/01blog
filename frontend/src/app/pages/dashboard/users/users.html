<div class="db-page-container">
    <app-db-page-header title="User Management" subtitle="Monitor and manage user accounts, roles and permissions."
        titleIcon="group" iconColor="var(--primary)" actionIcon="person_add" actionLabel="Add User"
        (onAction)="modalService.open('create-user')">
    </app-db-page-header>

    <!-- Toolbar -->
    <div class="db-toolbar users-toolbar">
        <div class="search-section">
            <span class="material-symbols-outlined search-icon">search</span>
            <input type="text" class="search-input" placeholder="Search by name, email or role..."
                [ngModel]="searchQuery()" (input)="onSearch($event)">
        </div>
        <div class="filter-section">
            <span class="filter-label">Filter</span>
            <div class="pill-group">
                <button class="pill-btn" [class.active]="statusFilter() === 'all'" (click)="setStatusFilter('all')"
                    title="All Users">
                    <span class="material-symbols-outlined">group</span>
                </button>
                <button class="pill-btn" [class.active]="statusFilter() === 'active'"
                    (click)="setStatusFilter('active')" title="Active Users">
                    <span class="material-symbols-outlined">person</span>
                </button>
                <button class="pill-btn" [class.active]="statusFilter() === 'banned'"
                    (click)="setStatusFilter('banned')" title="Banned Users">
                    <span class="material-symbols-outlined">block</span>
                </button>
                <button class="pill-btn" [class.active]="statusFilter() === 'admins'"
                    (click)="setStatusFilter('admins')" title="Administrators">
                    <span class="material-symbols-outlined">admin_panel_settings</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="db-card table-card" *ngIf="filteredUsers().length > 0 && !isLoading()">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="col-user">User</th>
                        <th class="col-role hide-md">Role</th>
                        <th class="col-status">Status</th>
                        <th class="col-date hide-lg">Joined</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of paginatedUsers()">
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar"
                                    [style.background-image]="'url(' + (user.avatar || 'assets/default-avatar.png') + ')'"
                                    (click)="router.navigate(['/profile', user.id])">
                                </div>
                                <div class="user-info">
                                    <h6 class="user-name" (click)="router.navigate(['/profile', user.id])">
                                        {{ user.name }}
                                    </h6>
                                    <p class="user-email">{{ user.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="hide-md">
                            <span class="role-badge" [class.admin]="user.role === 'ADMIN'">
                                {{ user.role }}
                            </span>
                        </td>
                        <td>
                            <div class="status-indicator-wrap" [class.banned]="user.banned">
                                <span class="status-dot"></span>
                                <span class="status-text hide-sm">{{ user.banned ? 'Banned' : 'Active' }}</span>
                            </div>
                        </td>
                        <td class="hide-lg">
                            <span class="date-text">{{ user.createdAt | date:'MMM d, yyyy' }}</span>
                        </td>
                        <td>
                            <div class="action-group">
                                <button class="btn-icon" [class.unban]="user.banned" [class.ban]="!user.banned"
                                    (click)="toggleBan(user)" [title]="user.banned ? 'Unban' : 'Ban'">
                                    <span class="material-symbols-outlined">{{ user.banned ? 'check_circle' : 'block'
                                        }}</span>
                                </button>
                                <button class="btn-icon danger" *ngIf="dataService.currentUser()?.isAdmin"
                                    (click)="deleteUser(user)" title="Delete Account">
                                    <span class="material-symbols-outlined">person_remove</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <app-db-pagination *ngIf="filteredUsers().length > 0 && !isLoading()" [pagination]="pagination"
        [totalItems]="filteredUsers().length" label="users">
    </app-db-pagination>

    <!-- Feedbacks -->
    <app-db-feedback *ngIf="filteredUsers().length === 0 && !isLoading()" type="empty" icon="person_search"
        iconColor="var(--primary)" title="No users found" message="Try adjusting your search or status filters.">
    </app-db-feedback>

    <app-db-feedback *ngIf="isLoading()" type="loading"></app-db-feedback>
</div>