<div class="db-page-container">
    <app-db-page-header title="Content Moderator"
        subtitle="Review platform posts, track engagement and manage visibility." titleIcon="article"
        iconColor="var(--success)" actionIcon="add" actionLabel="New Post"
        (onAction)="modalService.open('create-post')">
    </app-db-page-header>

    <!-- Toolbar -->
    <div class="db-toolbar posts-toolbar">
        <div class="search-section">
            <span class="material-symbols-outlined search-icon">search</span>
            <input type="text" class="search-input" placeholder="Filter by author or keyword..."
                [ngModel]="searchQuery()" (input)="setSearchQuery($any($event.target).value)">
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" [ngModel]="statusFilter()"
                    (change)="setStatusFilter($any($event.target).value)">
                    <option value="visible">Visible</option>
                    <option value="hidden">Hidden</option>
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Sort</label>
                <select class="filter-select" [ngModel]="sortBy()" (change)="setSortBy($any($event.target).value)">
                    <option value="newest">Newest First</option>
                    <option value="most-liked">Most Liked</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="db-card table-card" *ngIf="filteredPosts().length > 0 && !isLoading()">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="col-post">Post</th>
                        <th class="col-author hide-md">Author</th>
                        <th class="col-stats">Engagement</th>
                        <th class="col-status">Status</th>
                        <th class="col-date hide-lg">Date</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let post of paginatedPosts()">
                        <td>
                            <div class="post-cell">
                                <div class="post-preview" (click)="reviewPost(post)">
                                    <img *ngIf="post.image" [src]="post.image" alt="Thumbnail">
                                    <div *ngIf="!post.image" class="placeholder-icon">
                                        <span class="material-symbols-outlined">{{ post.hidden ? 'archive' : 'image'
                                            }}</span>
                                    </div>
                                </div>
                                <div class="post-info">
                                    <h6 class="post-title" (click)="reviewPost(post)" [title]="post.title">
                                        {{ post.hidden ? '[Hidden] ' : '' }}{{ post.title }}
                                    </h6>
                                    <p class="post-author-mobile hide-lg">by {{ post?.user?.name }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="hide-md">
                            <span class="author-name">{{ post?.user?.name }}</span>
                        </td>
                        <td>
                            <div class="stats-badges">
                                <span class="badge badge-stat likes" title="Likes">
                                    <span class="material-symbols-outlined">favorite</span>
                                    <span>{{ post.likes || 0 }}</span>
                                </span>
                                <span class="badge badge-stat comments" title="Comments">
                                    <span class="material-symbols-outlined">chat_bubble</span>
                                    <span>{{ post.comments || 0 }}</span>
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="status-cell">
                                <span class="status-indicator" [class.hidden]="post.hidden"
                                    [class.visible]="!post.hidden" [title]="post.hidden ? 'Hidden' : 'Visible'">
                                    <span class="material-symbols-outlined">{{ post.hidden ? 'visibility_off' :
                                        'visibility' }}</span>
                                </span>
                                <div class="report-warning" *ngIf="(post.reportsCount ?? 0) > 0">
                                    <span class="material-symbols-outlined">report</span>
                                    <span>{{ post.reportsCount }}</span>
                                </div>
                            </div>
                        </td>
                        <td class="hide-lg">
                            <span class="date-text">{{ post.createdAt | date:'MMM d, yyyy' }}</span>
                        </td>
                        <td>
                            <div class="action-group">
                                <button class="btn-icon" [class.unhide]="post.hidden" [class.hide]="!post.hidden"
                                    (click)="togglePostVisibility(post)"
                                    [title]="post.hidden ? 'Unhide Post' : 'Hide Post'">
                                    <span class="material-symbols-outlined">{{ post.hidden ? 'check_circle' : 'cancel'
                                        }}</span>
                                </button>
                                <button class="btn-icon delete" (click)="deletePost(post)" title="Delete Post">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                                <button class="btn-icon ban" *ngIf="post?.user" [class.unban]="post?.user?.banned"
                                    (click)="toggleBan(post.user)"
                                    [title]="post?.user?.banned ? 'Unban Author' : 'Ban Author'">
                                    <span class="material-symbols-outlined">{{ post?.user?.banned ? 'check_circle' :
                                        'block' }}</span>
                                </button>
                                <button class="btn-icon danger" *ngIf="dataService.currentUser()?.isAdmin"
                                    [disabled]="!post?.user" (click)="post?.user && deleteUser(post.user)" title="Delete Author">
                                    <span class="material-symbols-outlined">person_remove</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Feedbacks -->
    <app-db-feedback *ngIf="filteredPosts().length === 0 && !isLoading()" type="empty" icon="article"
        iconColor="var(--success)" title="No posts found" message="Try adjusting your search or category filters.">
    </app-db-feedback>

    <app-db-feedback *ngIf="isLoading()" type="loading"></app-db-feedback>

    <!-- Pagination -->
    <app-db-pagination *ngIf="filteredPosts().length > 0 && !isLoading()" [pagination]="pagination"
        [totalItems]="filteredPosts().length" label="posts">
    </app-db-pagination>
</div>
